<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºäº§åçº¦åŠ©æ‰‹</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .chat-container { width: 100%; max-width: 800px; height: 85vh; background: rgba(255, 255, 255, 0.92); border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.3); }
        .header { background: linear-gradient(90deg, #4776E6 0%, #8E54E9 100%); color: white; padding: 24px 30px; text-align: center; flex-shrink: 0; }
        .header h1 { font-size: 1.8rem; font-weight: 600; margin-bottom: 6px; }
        .header p { opacity: 0.9; font-size: 0.95rem; }
        #chat-box { flex-grow: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 80%; padding: 18px 22px; border-radius: 22px; line-height: 1.5; word-wrap: break-word; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { align-self: flex-end; background: linear-gradient(90deg, #4776E6, #8E54E9); color: white; border-bottom-right-radius: 6px; }
        .bot-message { align-self: flex-start; background-color: #f0f2f5; color: #333; border-bottom-left-radius: 6px; }
        .input-area { display: flex; padding: 25px 30px; border-top: 1px solid #eee; background-color: #fafbfc; flex-shrink: 0; gap: 15px; }
        #user-input { flex-grow: 1; padding: 18px 24px; border: 2px solid #e1e5eb; border-radius: 50px; font-size: 1rem; outline: none; transition: all 0.3s; background: white; }
        #user-input:focus { border-color: #8E54E9; box-shadow: 0 0 0 3px rgba(142, 84, 233, 0.1); }
        #send-btn { background: linear-gradient(90deg, #4776E6, #8E54E9); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 1.4rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        #send-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(142, 84, 233, 0.4); }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .typing-indicator { align-self: flex-start; padding: 18px 22px; background-color: #f0f2f5; border-radius: 22px; border-bottom-left-radius: 6px; display: none; }
        .typing-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #999; margin-right: 4px; animation: typing-bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1>ğŸ¤– æ™ºäº§åçº¦åŠ©æ‰‹</h1>
            <p>å·²è¿æ¥è‡³ä½ çš„æ™ºèƒ½ä½“ï¼Œè¯·å¼€å§‹å¯¹è¯å§ï¼</p>
        </div>
        <div id="chat-box">
            <!-- ã€ä¿æŒä¸å˜çš„æç¤ºè¯­ã€‘ -->
            <div class="message bot-message">
                ä½ å¥½ï¼Œæˆ‘æ˜¯æ™ºäº§åçº¦åŠ©æ‰‹ï¼Œè¯·é—®æ‚¨æœ‰ä»€ä¹ˆéœ€æ±‚å‘€ï¼Ÿ
            </div>
        </div>
        <div class="typing-indicator" id="typing">
            <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
        </div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
            <button id="send-btn">â¤</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing');

        // ==========ã€ä½ çš„å‡­è¯ - è¯·ç¡®ä¿å‡†ç¡®æ— è¯¯ã€‘==========
        const API_TOKEN = 'Bearer pat_5aFbUX4KeT0JnTFejJ5Dz6Ij5Qm7p0BctcsAf1fBHPGleAIF92HGBfakQMGKdMcY';
        const BOT_ID = '7582271628420448291';
        const API_URL = 'https://api.coze.cn/v3/chat'; // æˆ– open_api/v2/chat
        // ==============================================

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            appendMessage(message, 'user');
            userInput.value = '';
            sendBtn.disabled = true;
            callCozeAPI(message);
        }

        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}-message`;
            msgDiv.textContent = text;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ã€æ ¸å¿ƒã€‘ç¨³å¥çš„åŒæ­¥APIè°ƒç”¨å‡½æ•°
        async function callCozeAPI(userText) {
            typingIndicator.style.display = 'block';
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 45000); // 45ç§’è¶…æ—¶

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': API_TOKEN,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'bot_id': BOT_ID,
                        'user': 'user_123',
                        'query': userText,
                        'stream': false // åŒæ­¥è¯·æ±‚
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await response.json();
                typingIndicator.style.display = 'none';

                if (!response.ok) {
                    appendMessage(`æœåŠ¡å¼‚å¸¸(${response.status}): ${data.msg || 'è¯·æ£€æŸ¥é…ç½®'}`, 'bot');
                    return;
                }

                // æå–å›å¤å†…å®¹
                let finalReply = '';
                if (data?.messages?.[0]?.content) {
                    finalReply = data.messages[0].content;
                } else if (data?.content) {
                    finalReply = data.content;
                } else {
                    finalReply = 'æ™ºèƒ½ä½“å·²å“åº”ï¼Œä½†è¿”å›æ ¼å¼æœªè¯†åˆ«ã€‚å®Œæ•´æ•°æ®: ' + JSON.stringify(data);
                }
                appendMessage(finalReply, 'bot');

            } catch (error) {
                clearTimeout(timeoutId);
                typingIndicator.style.display = 'none';
                if (error.name === 'AbortError') {
                    appendMessage('æ€è€ƒè¶…æ—¶ï¼ˆ45ç§’ï¼‰ã€‚æ‚¨çš„é—®é¢˜å¯èƒ½è¾ƒå¤æ‚ï¼Œè¯·ç®€åŒ–æˆ–ç¨åé‡è¯•ã€‚', 'bot');
                } else {
                    appendMessage(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error.message}`, 'bot');
                }
                console.error('APIè°ƒç”¨é”™è¯¯è¯¦æƒ…:', error);
            } finally {
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        userInput.addEventListener('input', () => { sendBtn.disabled = !userInput.value.trim(); });
        window.onload = () => userInput.focus();
    </script>
</body>
</html>